<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>L'Oréal | Virtual Makeup</title>
  <link rel="icon"
    href="https://d1yjjnpx0p53s8.cloudfront.net/styles/logo-thumbnail/s3/0000/2125/brand.gif?itok=9H79h1nR" />
  <link rel="stylesheet" href="assets/buefy.min.css" />
  <style>
    html,
    body,
    #webar {
      overflow: hidden;
      width: 100%;
      height: 100%;
    }

    #webar {
      display: flex;
      align-content: center;
      justify-content: center;
    }

    #webar>canvas {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain !important;
    }

     /* Landing page styles */
      #landing-page {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #f8f3f3 0%, #f5e8e8 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        font-family: 'Helvetica Neue', Arial, sans-serif;
      }
      
      .landing-container {
        background: white;
        border-radius: 12px;
        padding: 2.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 450px;
        text-align: center;
      }
      
      .loreal-logo {
        width: 180px;
        margin-bottom: 1.5rem;
      }
      
      .landing-title {
        color: #d1006b;
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      
      .landing-subtitle {
        color: #666;
        margin-bottom: 2rem;
        font-size: 1rem;
      }
      
      .field {
        margin-bottom: 1.5rem;
        text-align: left;
      }
      
      .field-label {
        color: #333;
        font-weight: 500;
        margin-bottom: 0.5rem;
        display: block;
      }
      
      .input, .select select {
        width: 100%;
        border-radius: 6px;
        border: 1px solid #ddd;
        padding: 0.75rem;
        font-size: 1rem;
        transition: all 0.3s;
      }
      
      .input:focus, .select select:focus {
        border-color: #d1006b;
        box-shadow: 0 0 0 2px rgba(209, 0, 107, 0.2);
      }
      
      .gender-options {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
      }
      
      .gender-option {
        flex: 1;
        text-align: center;
        padding: 0.75rem;
        border: 2px solid #eee;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .gender-option.selected {
        border-color: #d1006b;
        background-color: rgba(209, 0, 107, 0.05);
      }
      
      .gender-option i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: block;
        color: #888;
      }
      
      .gender-option.selected i {
        color: #d1006b;
      }
      
      .start-button {
        background-color: #d1006b;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
        margin-top: 1rem;
      }
      
      .start-button:hover {
        background-color: #b0005a;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(209, 0, 107, 0.3);
      }
      
      .start-button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      
      .error-message {
        color: #ff3860;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        display: none;
      }
  </style>
</head>

<body>
  <!-- Landing Page -->
  <div id="landing-page">
    <div class="landing-container">
      <img
        src="https://d1yjjnpx0p53s8.cloudfront.net/styles/logo-thumbnail/s3/0000/2125/brand.gif?itok=9H79h1nR"
        alt="L'Oréal" class="loreal-logo">
      <h1 class="landing-title">Virtual Makeup Experience</h1>
      <p class="landing-subtitle">Please provide your information to personalize your experience</p>
  
      <div class="field">
        <label class="field-label">Age</label>
        <div class="control">
          <input class="input" type="number" id="age-input" min="13" max="100" placeholder="Enter your age">
        </div>
        <p class="error-message" id="age-error">Please enter a valid age (13-100)</p>
      </div>
  
      <div class="field">
        <label class="field-label">Gender</label>
        <div class="gender-options">
          <div class="gender-option" data-gender="female">
            <i class="fas fa-female"></i>
            <span>Female</span>
          </div>
          <div class="gender-option" data-gender="male">
            <i class="fas fa-male"></i>
            <span>Male</span>
          </div>
          <div class="gender-option" data-gender="other">
            <i class="fas fa-user"></i>
            <span>Other</span>
          </div>
        </div>
        <p class="error-message" id="gender-error">Please select your gender</p>
      </div>
  
      <button id="start-button" class="start-button" disabled>Start Experience</button>
    </div>
  </div>
  <bnb-app>
    <div id="webar"></div>
  </bnb-app>

  <script src="BanubaClientToken.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exifr/dist/lite.umd.js"></script>
  <script type="module">
    import {
      Effect,
      Webcam,
      Image,
      Player,
      Module,
      ImageCapture,
      Dom,
    } from "https://cdn.jsdelivr.net/npm/@banuba/webar@1.17.0/dist/BanubaSDK.browser.esm.min.js";
    import { zipSync as zip } from "https://cdn.jsdelivr.net/npm/fflate@0.6.4/esm/browser.min.js";
    import App from "./src/app.js";
    import Store from "./src/store.js";

    App.$children[0].toggleLoading();


    // Add these functions to the main script in index.html
      function startRecordingUserSelections() {
        // Import the store functions
        import('./src/store.js').then(storeModule => {
          storeModule.startRecording();
        });
      }

      function stopRecordingAndSave() {
        import('./src/store.js').then(async (storeModule) => {
          storeModule.stopRecording();
          const history = storeModule.getUserPresetHistory();

          if (history.length > 0) {
            await savePresetHistoryToFile(history);
          }
        });
      }

      async function savePresetHistoryToFile(history) {
        try {
          const presetData = {
            timestamp: new Date().toISOString(),
            userSelections: history,
            summary: generatePresetSummary(history)
          };

          const blob = new Blob([JSON.stringify(presetData, null, 2)], {
            type: 'text/plain'
          });

          const fileName = `user_preset_history_${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;

          // Create download link
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = fileName;
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(a.href);

          console.log(`Preset history saved to ${fileName}`);
        } catch (error) {
          console.error('Error saving preset history:', error);
        }
      }

      function generatePresetSummary(history) {
        const summary = {};

        history.forEach(change => {
          if (!summary[change.module]) {
            summary[change.module] = {};
          }

          if (typeof change.key === 'string') {
            summary[change.module][change.key] = change.value;
          } else {
            // Handle bulk updates
            Object.assign(summary[change.module], change.key);
          }
        });

        return summary;
      }

      // Modify the visibility change listener to handle recording
      const visibilityChangeListener = async () => {
        const isActive = document.visibilityState === 'visible';

        if (source !== "webcam") return;

        if (!isActive) {
          input.stop();
          // Save recording when tab becomes inactive
          stopRecordingAndSave();
        } else {
          await useWebcam();
          // Restart recording when tab becomes active
          startRecordingUserSelections();
        }
      };



    !(async () => {
      let input;
      let source;
      const [player, modules, effect] = await Promise.all([
        Player.create({
          devicePixelRatio: 1,
          clientToken: window.BANUBA_CLIENT_TOKEN,
        }),
        Module.preload(
          ["background", "eyes", "face_tracker", "hair", "lips", "skin"].map(
            (m) =>
              `https://cdn.jsdelivr.net/npm/@banuba/webar@1.17.0/dist/modules/${m}.zip`
          )
        ),
        Effect.preload("assets/Makeup_new_morphs.zip"),
      ]);
      await player.addModule(...modules);
      await player.applyEffect(effect);

      App.$children[0].toggleLoading();

      // Start recording user selections
      startRecordingUserSelections();

      //#region fps count
      const fps = {
        cam: 0,
        processing: 0,
        render: 0,
      };
      player.addEventListener("framereceived", () => fps.cam++);
      player.addEventListener(
        "frameprocessed",
        ({ detail }) => (fps.processing = 1000 / detail.averagedDuration)
      );
      player.addEventListener("framerendered", () => fps.render++);

      setInterval(() => {
        Object.entries(fps).forEach(([name, value]) => {
          fps[name] = 0;
          document.getElementById(name).innerText = value.toFixed(1);
        });
      }, 1000);
      //#endregion

      const useWebcam = async () => {
        source = "webcam";
        player.use((input = new Webcam()));
        player.play();
      };
      const useImage = async (file) => {
        source = "image";
        player.use((input = new Image(file)));
        player.play();
      };
      const takeScreenshot = async () => {
        const capture = new ImageCapture(player);
        download(await capture.takePhoto(), "WebAR_Beauty");
      };
      const stop = async () => {
        input?.stop?.();
      };

      const resizeObserver = new ResizeObserver(
        ([{ target, contentRect }]) =>
        (target.style.objectFit =
          contentRect.height > contentRect.width ? "contain" : "cover")
      );
      const render = () => {
        Dom.render(player, "#webar");
        resizeObserver.observe(document.querySelector("#webar > canvas"));
      };
      const unmount = () => Dom.unmount("#webar");

      const writeFile = (file) =>
        (file instanceof File ? Promise.resolve(file) : fetch(file))
          .then((res) => res.arrayBuffer())
          .then((buffer) => effect.writeFile(file.name || file, buffer));
      const evalJs = (code, files = []) =>
        Promise.all(files.filter(Boolean).map(writeFile)).then(() =>
          effect.evalJs(code)
        );

      const visibilityChangeListener = async () => {
        const isActive = document.visibilityState === "visible";

        if (source !== "webcam") return;

        if (!isActive) {
          input.stop();
        } else {
          await useWebcam();
        }
      };
      document.addEventListener("visibilitychange", visibilityChangeListener);

      App.$on("camera-request", () => useWebcam().then(render));
      App.$on("photo-uploaded", (file) => useImage(file).then(render));
      App.$on("screenshot-request", takeScreenshot);
      App.$on("close-request", stop), App.$on("close-request", unmount);
      App.$on("preset-download-request", (preset) =>
        download(appendToConfig(effect, presetToCode(preset)), "Makeup.zip")
      );
      App.$on("preset-copy-request", (preset) =>
        copyToClipboard(presetToCode(preset))
      );
      App.$on("close-request", stop), App.$on("close-request", unmount);

      Store.on("look:changed", ({ texture = "" }) =>
        evalJs(`Makeup.set("${texture}")`, [texture])
      );
      Store.on("face-makeup:changed", (name, { color, enabled }) =>
        evalJs(`Makeup.${name}("${enabled ? color : "0 0 0 0"}")`)
      );
      Store.on("eyes-makeup:changed", (name, { color, enabled }) =>
        evalJs(`Makeup.${name}("${enabled ? color : "0 0 0 0"}")`)
      );
      Store.on("skin:changed", (name, { color, enabled, strength }) => {
        typeof strength !== "undefined"
          ? evalJs(`Skin.${name}(${strength})`)
          : evalJs(`Skin.${name}("${enabled ? color : "0 0 0 0"}")`);
      });
      Store.on("morphs:changed", (name, { strength }) =>
        evalJs(`FaceMorph.${name}(${strength})`)
      );
      Store.on("teeth-whitening:changed", ({ strength }) =>
        evalJs(`Teeth.whitening(${strength})`)
      );
      Store.on("eyes:changed", (name, { enabled, color, strength }) => {
        typeof strength !== "undefined"
          ? evalJs(`Eyes.${name}(${strength})`)
          : evalJs(`Eyes.${name}("${enabled ? color : "0 0 0 0"}")`);
      });
      Store.on("eyelashes:changed", ({ enabled, color }) => {
        evalJs(`Eyelashes.color("${enabled ? color : "0 0 0 0"}")`);
      });
      Store.on("brows:changed", ({ enabled, color }) =>
        evalJs(`Brows.color("${enabled ? color : "0 0 0 0"}")`)
      );
      Store.on("softlight:changed", ({ strength }) =>
        evalJs(`Softlight.strength(${strength})`)
      );
      Store.on("hair:changed", ({ enabled, color }) =>
        evalJs(
          `Hair.color(${enabled ? color.map((c) => `"${c}"`) : `"0 0 0 0"`})`
        )
      );
      Store.on("lipstick:changed", ({ enabled, color }) =>
        evalJs(`Lips.color("${enabled ? color : "0 0 0 0"}")`)
      );
      Store.on("lipstick-params:changed", (name, { value }) =>
        evalJs(`Lips.${name}(${value})`)
      );
      Store.on("background:changed", async (name, value) => {
        if (name === "texture" && typeof value === "string")
          value = await createFile(value);
        evalJs(
          `Background.${name}(${value instanceof File
            ? `"${value.name}"`
            : typeof value === "string"
              ? `"${value}"`
              : value
          })`,
          value instanceof File ? [value] : []
        );
      });
      Store.on("lut:changed", ({ texture = "" }) =>
        evalJs(`Filter.set("${texture}")`, [texture])
      );
      

    })();

    /* Utils */
    function appendToConfig(effect, code) {
      code = new TextEncoder().encode(code);

      const data = effect["_resource"]["_data"];
      const cfg = data["config.js"];

      // Convert the config to string to find and remove the comment
      const configStr = new TextDecoder().decode(cfg);

      // Remove the comment line
      const cleanedConfig = configStr.replace(/\/\/ feel free to add your custom code below[\r\n]*/, '');

      // Convert back to Uint8Array
      const cleanedCfg = new TextEncoder().encode(cleanedConfig);

      return { ...data, "config.js": new Uint8Array([...cfg, ...code]) };
    }

    function presetToCode({
      background,
      brows,
      eyelashes,
      eyes,
      eyesMakeup,
      hair,
      lipstick,
      lipstickParams,
      look,
      lut,
      morphs,
      faceMakeup,
      skin,
      softlight,
      teethWhitening,
    }) {
      const commands = [];

      if (background)
        for (const [name, value] of Object.entries(background))
          commands.push(
            `Background.${name}(${typeof value === "string" ? `"${value}"` : value
            })`
          );

      if (brows) commands.push(`Brows.color("${brows}")`);

      if (eyelashes) commands.push(`Eyelashes.color("${eyelashes}")`);

      if (eyes)
        for (const [name, value] of Object.entries(eyes))
          commands.push(`Eyes.${name}(${value})`);

      if (eyesMakeup)
        for (const [name, value] of Object.entries(eyesMakeup))
          commands.push(`Makeup.${name}("${value}")`);

      if (hair) commands.push(`Hair.color(${hair.map((c) => `"${c}"`)})`);

      if (lipstick) commands.push(`Lips.color("${lipstick}")`);

      if (lipstickParams)
        for (const [name, value] of Object.entries(lipstickParams))
          commands.push(`Lips.${name}(${value})`);

      if (look) commands.push(`Makeup.set("${look}")`);

      if (lut) commands.push(`Filter.set("${lut}")`);

      if (morphs)
        for (const name in morphs)
          commands.push(`FaceMorph.${name}(${morphs[name]})`);

      if (faceMakeup)
        for (const [name, value] of Object.entries(faceMakeup))
          commands.push(`Makeup.${name}("${value}")`);

      if (skin)
        for (const [name, value] of Object.entries(skin))
          commands.push(
            `Skin.${name}(${typeof value === "string" ? `"${value}"` : value
            })`
          );

      if (softlight) commands.push(`Softlight.strength(${softlight})`);

      if (teethWhitening) commands.push(`Teeth.whitening(${teethWhitening})`);

      return commands.join(";\n");
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text);
    }

    function download(blob, name) {
      if (!(blob instanceof Blob)) blob = new Blob([zip(blob)]);

      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = name;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    async function createFile(url) {
      const data = await fetch(url).then((response) => response.blob());
      return new File([data], url);
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const ageInput = document.getElementById('age-input');
      const genderOptions = document.querySelectorAll('.gender-option');
      const startButton = document.getElementById('start-button');
      const ageError = document.getElementById('age-error');
      const genderError = document.getElementById('gender-error');
      const landingPage = document.getElementById('landing-page');
      const webarPage = document.getElementById('webar-page');

      let selectedGender = null;
      let ageValid = false;
      let genderValid = false;

      // Age validation
      ageInput.addEventListener('input', function () {
        const age = parseInt(this.value);

        if (isNaN(age) || age > 100) {
          ageError.style.display = 'block';
          ageValid = false;
        } else {
          ageError.style.display = 'none';
          ageValid = true;
        }

        updateStartButton();
      });

      // Gender selection
      genderOptions.forEach(option => {
        option.addEventListener('click', function () {
          genderOptions.forEach(opt => opt.classList.remove('selected'));
          this.classList.add('selected');
          selectedGender = this.getAttribute('data-gender');
          genderError.style.display = 'none';
          genderValid = true;

          updateStartButton();
        });
      });

      // Update button state
      function updateStartButton() {
        startButton.disabled = !(ageValid && genderValid);
      }

      // Start the experience
      startButton.addEventListener('click', function () {
        // Store user data (you could send this to analytics or your backend)
        const userData = {
          age: ageInput.value,
          gender: selectedGender,
          timestamp: new Date().toISOString()
        };

        console.log('User data:', userData);

        // Hide landing page and show webar experience
        landingPage.style.display = 'none';
        webarPage.style.display = 'block';
      });
    });

    // Save recording when the app is closed
      App.$on("close-request", () => {
        stopRecordingAndSave();
        stop();
        unmount();
      });

      // In the landing page script section
        startButton.addEventListener('click', function () {
          const userData = {
            age: ageInput.value,
            gender: selectedGender,
            timestamp: new Date().toISOString()
          };

          console.log('User data:', userData);

          // Hide landing page and show webar experience
          landingPage.style.display = 'none';

          // Start recording user selections
          startRecordingUserSelections();
        });



        App.$on("save-history-request", () => {
            stopRecordingAndSave();
          });

  </script>
</body>

</html> 